#!/bin/sh

set -e

bootstrap() {
	local root=$1

	debootstrap --arch amd64 precise $root http://mirror.yandex.ru/ubuntu

	cat > $root/etc/resolvconf/resolv.conf.d/base <<EOF
search search.yandex.net yandex.ru
nameserver 2a02:6b8:0:3400::1
nameserver 2a02:6b8::1:1
options timeout:1 attempts:1
EOF

	cat > $root/etc/apt/sources.list <<EOF
deb http://mirror.yandex.ru/ubuntu precise main restricted universe multiverse
deb http://mirror.yandex.ru/ubuntu/ precise-updates main restricted
deb http://mirror.yandex.ru/ubuntu/ precise-security main restricted
EOF

	cat > $root/etc/apt/sources.list.d/yandex.list <<EOF
deb http://common.dist.yandex.ru/common stable/all/
deb http://common.dist.yandex.ru/common stable/amd64/
EOF

	cat > $root/etc/apt/sources.list.d/yandex-search.list <<EOF
deb http://search.dist.yandex.ru/search stable/all/
deb http://search.dist.yandex.ru/search unstable/all/

deb http://search.dist.yandex.ru/search stable/amd64/
deb http://search.dist.yandex.ru/search unstable/amd64/
EOF

	cat > $root/etc/apt/sources.list.d/yandex-search-kernel.list <<EOF
deb http://search-kernel.dist.yandex.ru/search-kernel stable/all/
deb http://search-kernel.dist.yandex.ru/search-kernel unstable/all/

deb http://search-kernel.dist.yandex.ru/search-kernel stable/amd64/
deb http://search-kernel.dist.yandex.ru/search-kernel unstable/amd64/
EOF

	cat > $root/etc/apt/sources.list.d/yandex-search-precise.list <<EOF
deb http://search-precise.dist.yandex.ru/search-precise stable/all/
deb http://search-precise.dist.yandex.ru/search-precise unstable/all/

deb http://search-precise.dist.yandex.ru/search-precise stable/amd64/
deb http://search-precise.dist.yandex.ru/search-precise unstable/amd64/
EOF
}

prepare() {
	resolvconf -u
	apt-get update
	apt-get install -y --force-yes linux-libc-dev=3.10.53-14 debhelper devscripts git cmake g++-4.7 make protobuf-compiler bison flex pkg-config autoconf libtool libprotobuf-dev
	apt-get install -y --force-yes git
}

check() {
	git clone $1 $2
	cd $2
	git submodule init
	git submodule update
	debuild -i -us -uc -b

	mkdir -p /boot/grub/
	touch /boot/grub/menu.lst
	apt-get install -y grub
	echo "#!/bin/sh" > /sbin/update-grub
	echo "#!/bin/sh" > /sbin/update-initramfs

	apt-get install -y --force-yes linux-image-server linux-image-3.10.59-19 linux-firmware wireless-crda crda libnl-3-200 libnl-genl-3-200 wireless-regdb linux-tools linux-headers-3.10.59-19 kexec-tools anacron makedumpfile libdw1

	apt-get install -y --force-yes logrotate
	groupadd porto || :
	dpkg -i /yandex-porto_*_amd64.deb
	apt-get install -y --force-yes python-central python-protobuf
	dpkg -i /python-portopy_*_all.deb

	# make sure package is installed
	for binary in portod portoctl portotest; do
		which $binary || { echo "ERROR: Can't find $binary"; exit 1; }
	done

	# TODO: selftest
	#portotest
}

eval "$@"
