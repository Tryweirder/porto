#!/bin/sh

set -e

ROOTDIR=$(cd $(dirname $0)/../ && pwd)

say() { [ ! -t 1 ] || tput setaf 3; echo "$@"; [ ! -t 1 ] || tput sgr0; }

selftest() {
	say "Self test with network=$1"
	echo "network { enabled: $1 dynamic_ifaces: false } container { use_hierarchy: true } privileges { root_user: \"$USER\" }" > /etc/portod.conf
	portotest
}

stresstest() {
	say "Stress test"
	portotest stress
}

pkgtest() {
	say "Package test"
	for f in $ROOTDIR/dist/*.conf; do
		$ROOTDIR/scripts/mkimg 5G ${f}.img $f -vT -c $ROOTDIR -C
	done
}

[ ! $# -eq 0 ] || set -- false true pkg stress
for t in "$@"; do
	case $t in
		true|false) selftest $t ;;
		stress) stresstest ;;
		pkg) pkgtest ;;
		*) say "Invalid test $t"; exit 1 ;;
	esac
done
